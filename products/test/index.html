<!DOCTYPE html>
<!--[if IE 8]>         <html class="ie8"> <![endif]-->
<!--[if IE 9]>         <html class="ie9"> <![endif]-->
<!--[if gt IE 9]><!--> <html> <!--<![endif]-->
<head>
    <title class="Test"></title>
    <meta charset="UTF-8">
    <link href="style.css" rel="stylesheet">
</head>
<body>

    <div id="id-start_slide" class="wrapper">
        <div class="back_start"></div>
        <div class="shadow"></div>
        <div class="slide">
            <div class="cnt_wr">
                <div class="start_txt">
                    <h2 id="id-start_header_text" data-app-property="startHeaderText" class="start_head"></h2>
                    <span id="id-start_desc_text" data-app-property="startDescription" class="start_desc">Проверь свои знания в географии</span>
                </div>
                </br>
                <div class="btn_wr">
                    <span class="t_btn js-next">Начать</span>
                </div>
            </div>
        </div>
    </div>

    <div class="js-slides_cnt">
        <!-- Слайды с вопросами добавлятся программно сюда -->
    </div>

    <div id="id-end_slide">
        <!-- Сюда добавляется один из результатов. Который собирается из шаблона. -->
    </div>

    <script type="text/javascript" src="utils.js"></script>
    <script type="text/javascript" src="jquery.js"></script>
    <script id="id-slide_template" type="text/template">
        <div class="wrapper">
            <div class="back_start"></div>
            <div class="shadow"></div>
            <div class="slide js-slide">
                <div class="cnt_wr">
                    <div class="q_wr">
                        <span data-app-property="quiz.{{currentQuestion}}.text">{{question_text}}</span>
                    </div>
                    <div data-app-property="quiz.{{currentQuestion}}.options" class="js-answers_cnt">
                        <!-- Сюда программно добавляются варианта ответов -->
                    </div>
                    <div class="js-explain explain_blk" style="display:none;">
                        <div class="js-explanation_text"></div>
                        </br>
                        </br>
                        <div><span class="btn js-next">Далее</span></div>
                    </div>
                </div>
            </div>
        </div>
    </script>
    <script id="id-answer_template" type="text/template">
        <!-- TODO: Атрибут есть во вью, а appProperty нет. Так как это нужно для связи DeleteQuickButton. Пока ничего лучше не придумал -->
        <div class="a_wr js-answer js-answer_text" data-app-property="quiz.{{currentQuestion}}.options.{{currentOption}}">
            <div class="a_text">
                <div class="point"></div>
                <span data-app-property="quiz.{{currentQuestion}}.options.{{currentOption}}.text" class="txt">{{answer_options_text}}</span>
            </div>
        </div>
    </script>
    <script id="id-result_template" type="text/template">
        <div class="wrapper">
            <div class="back_start"></div>
            <div class="shadow"></div>
            <div class="slide">
                <div class="cnt_wr">
                    <div class="start_txt">
                        <h2 class="start_head js-result_title">Конец</h2>
                        <span class="start_desc js-result_description">Ты ответил на все вопросы</span>
                    </div>
                    </br>
                    <div class="btn_wr">
                        <span data-app-property="restartButtonText" class="t_btn js-next js-restart">Заново</span>
                    </div>
                </div>
            </div>
        <div>
    </script>
    <script>
        /**
         * Например, можно объявить такой конфиг в контексте window страницы.
         * Engine будет иметь возможность редактировать данные через этот интерфейс
         *
         * Здесь можно описать свойства типа ключ-значение, которые будут влиять на поведение теста
         *
         * На основани объекта app будут построены settings продукта. То, что можно редактировать.
         *
         * @type {object}
         */
        var app = {

            d__startHeaderText: 'editable=true;ui=TextQuickInput',
            startHeaderText: 'Тест по географии',

            d__startDescription: 'editable=true;ui=TextQuickInput',
            startDescription: 'Проверь свои знания в географии',

            d__restartButtonText: 'editable=true;ui=TextQuickInput',
            restartButtonText: 'Заново',

            key1: 'value1',
            key2: 'value2',

            randomizeQuestions: false,
            randomizeOptions: false,

            /**
             * Что и как хотим менять?
             *
             * Стиль класса?
             * Стиль отдельного элемента html?
             * Атрибут html
             * Добавлять новый html элемент в указанное место
             * Удалять html элемент
             * Тексты в html
             * Переменную в js
             * переключатели между css свойствами, например, display
             *
             */
            slide: {
                canAdd: true,
                comment: 'Добавить слайд',
                templateId: 'id-slide_templ',
                parent: '.js-questions_cnt'
            },

            d__fontColor: 'editable=true',
            fontColor: '#fff',
            d__fontFamily: 'editable=true',
            fontFamily: 'Arial',
            d__background: 'editable=true',
            background: 'url(https://s3.eu-central-1.amazonaws.com/proconstructor/facebook-902609146442342/test1/i/Globe7.jpg)',

            /**
             * Будет показано объяснения, если оно указано для вопроса.
             * Причем есть возможность указать explanation для вопроса, так и для варианта ответа (option)
             * Приоритетнее: для варианта ответа, а потом уже (если есть) для всего вопроса
             */
            showExplanation: true,
            d__showExplanation: 'editable=true',

            /**
             * Вопросы с ответами
             */
            d__quiz: 'editable=true;length={apps.tests.maxquizcount};canAdd=proto__text_slide,proto__photo_question_slide',
            quiz: [
                {
                    d__text: 'editable=true;ui=TextQuickInput;default={config.textForTest};maxlength=10',
                    text: 'Мадагаскар -- это где?',
                    d__options: 'editable=true;ui=AddQuickButton,DeleteQuickButton',
                    options: [
                        {
                            d__text: 'editable=true;ui=TextQuickInput;',
                            text: 'Страна на западе Африки',
                            type: 'text',
                            explanation: 'Это страна, но не на западе.'
                        },
                        {
                            d__text: 'editable=true;ui=TextQuickInput;',
                            text: 'Остров в Атлантическом океане',
                            type: 'text',
                            explanation: 'Остров, но не в Атлантике.'
                        },
                        {
                            d__text: 'editable=true;ui=TextQuickInput;',
                            text: 'Остров на юге Африки',
                            type: 'text',
                            points: 1,
                            explanation: 'Да, верно'
                        }
                    ],
                    explanation: 'Конечно, это остров на юге Африки в индийском океане.'
                },
                {
                    d__text: 'editable=true;ui=TextQuickInput;default={config.textForTest};maxlength=10',
                    text: 'Какая самая большая страна?',
                    d__options: 'editable=true;ui=AddQuickButton',
                    options: [
                        {
                            d__text: 'editable=true;ui=TextQuickInput;',
                            text: 'Гренландия'
                        },
                        {
                            d__text: 'editable=true;ui=TextQuickInput;',
                            text: 'Россия',
                            points: 1
                        },
                        {
                            d__text: 'editable=true;ui=TextQuickInput;',
                            text: 'Австралия'
                        }
                    ],
                    explanation: 'Это Россия, все знают.'
                },
                {
                    d__text: 'editable=true;ui=TextQuickInput;default={config.textForTest};maxlength=10',
                    text: 'Какого моря не существует?',
                    d__options: 'editable=true;ui=AddQuickButton',
                    options: [
                        {
                            d__text: 'editable=true;ui=TextQuickInput;',
                            text: 'Черное море'
                        },
                        {
                            d__text: 'editable=true;ui=TextQuickInput;',
                            text: 'Синее море',
                            points: 1
                        },
                        {
                            d__text: 'editable=true;ui=TextQuickInput;',
                            text: 'Красное море'
                        },
                        {
                            d__text: 'editable=true;ui=TextQuickInput;',
                            text: 'Желтое море'
                        }
                    ]
                }
            ],

            /**
             * Описание результатов, которые можно получить
             */
            results: [
                {
                    minPoints: 0,
                    maxPoints: 1,
                    title: 'Новичок',
                    description: 'Неплохо для начала.'
                },
                {
                    minPoints: 2,
                    maxPoints: 3,
                    title: 'Средний',
                    description: 'Уже лучше, давай ещё'
                }
            ],
            d__results: 'editable=true;',

            // шаблон текстового вопроса
            proto__text_slide: {
                uiTemplate: 'id-slide_template',
                text: 'Текст вопроса?',
                d__text: 'editable=true;',
                options: [
                    {
                        text: 'Вариант ответа 1',
                        points: 1
                    },
                    {
                        text: 'Вариант ответа 2'
                    }
                ],
                d__explanation: 'editable=true;',
                explanation: 'Пояснение к ответу'
            },

            // шаблон фото вопроса
            proto__photo_question_slide: {
                uiTemplate: 'id-slide_photo_template',
                text: 'Текст фото вопроса?',
                d__text: 'editable=true;',
                img: '',
                options: [
                    {
                        text: 'Вариант ответа 1',
                        points: 1
                    },
                    {
                        text: 'Вариант ответа 2'
                    }
                ],
                d__explanation: 'editable=true;',
                explanation: 'Пояснение к ответу'
            }
        };
        /**
         * Экраны приложения;
         * Настраивает разработчика на то, чтобы сразу работать с экранами
         * Обязательное свойство, любое промо-приложение обладает конечным списком экранов.
         * {
         *      id: {string},
         *      view: {HTMLDOMElement | string | jQueryHTMLDOMElement},
         *      data: {*}
         * }
         */
        var screens = [];
        /**
         * тайтл результата по умолчанию
         */
        var DEF_RESULT_TITLE = 'Конец теста';
        /**
         * Описание результата по умолчанию
         */
        var DEF_RESULT_DESCRIPTION = 'Ты ответил на все вопросы';
        /**
         *
         */
        var resultPoints = 0;
        var currentQuestionIndex = -1;
        /**
         * Id опции, которую выбрал пользователь
         */
        var currentOptionId = '';
        var state = undefined; //'welcome', 'test', 'final'
        /**
         * {Object} Результат, полученный пользователем. Из массива app.results
         */
        var currentResult = null;
        /**
         * Ссылка на движок, сохраняется если была передана в start
         */
        var engineInstance = null;
        /**
         * Режим предпросмотра экранов. То есть приложение не запущено по настоящему. (?)
         * Активируется при вызове функции showScreen
         */
        var previewMode = false;

        function next() {
            //TODO на основе модели переходов можно построить блок схему для пользователя (если лучше формализовать модель)
            if (previewMode === false) {
                switch (state) {
                    case 'welcome': {
                        resultPoints = 0;
                        currentResult = null;
                        $('.js-explain').hide();
                        // currentQuestionIndex устанавливается внутри
                        renderQuestion(0);
                        $('#id-start_slide').hide();
                        $('.js-slides_cnt').show();
                        state = 'test';
                        break;
                    }
                    case 'test': {
                        if (currentQuestionIndex < app.quiz.length-1) {
                            renderQuestion(++currentQuestionIndex);
                        }
                        else {
                            // конец теста, финальный скрин
                            $('.js-slides_cnt').hide();
                            //TODO посчитать результат
                            currentResult = getResult(resultPoints);
                            renderResult(currentResult);
                            $('#id-end_slide').show();
                            state = 'final';
                        }
                        break;
                    }
                    case 'final': {
                        $('#id-end_slide').hide();
                        $('#id-start_slide').show();
                        state = 'welcome';
                        break;
                    }
                    default: {
                        state = 'welcome';
                        $('#id-start_slide').show();
                        $('#id-end_slide').hide();
                        $('.js-slides_cnt').hide();
                    }
                }
            }
        }

        $('.js-next').click(function() {
            next();
        });

        /**
         * Найти результат в массиве app.results для указанного количества баллов.
         * @param points - количество баллов, для которых найти результат
         */
        function getResult(points) {
            for (var i = 0; i < app.results.length; i++) {
                var r = app.results[i];
                if (r.minPoints <= points && points <=r.maxPoints) {
                    return r;
                }
            }
            return null;
        }

        /**
         * Автотесты, описанные разработчиком промо-прототипа. Свойство 'test' является обязательным.
         * Это массив функций, каждая из которых производит проверки.
         * Рекомендуется в рамках ондной функции реализовать одну логическую проверку.
         *
         * Функция должна принимать параметр 'app' - свойства приложения.
         * Важно: не использовать параметры window.app, а пользоваться параметром
         *
         * Для выполнения проверок пользоваться функцией engine.test(actual, expected, message)
         */
        var tests = [
            //TODO можно универсальные сделать тесты для любого проекта на проверку app
                //корректные дескрипторы
                //наличие app tests start
                //

            /**
             * Минимальный результат меньше максимального
             * @returns {boolean}
             */
            function resultMinMax(app, engine) {
                for (var i = 0; i < app.results.length; i++) {
                    var r = app.results[i];
                    if (r.minPoints <= r.maxPoints) {
                        // QUnit included
                        engine.test(r.minPoints <= r.maxPoints, true, 'Минимальный результат меньше максимального');
                    }
                }
            },
            /**
             * Вопросов должно быть хотя бы 1 штука
             */
            function questionsCount(app, engine) {
                engine.test(questions.length > 0, true, 'Вопросов должно быть хотя бы 1 штука');
            },

            function test1(app, engine) {
                engine.test(typeof app.randomizeQuestions == "boolean", true, 'true or false');
            },

            function test2(app, engine) {
                engine.test(typeof app.background == 'string', true, 'background string url');
            }
        ];

        /**
         * Метод, который должен быть определен обязательно
         * После обновления 'app' этот метод должен сделать всё нужное, чтобы приложение работало нормально.
         * Обычно start зовется и после загрузки html страницы в первый раз.
         *
         * @param {object} [params.engine] - когда проект запускается движком сюда будет передана ссылка на движок
         */
        function start(params) {
            // параметры от движка
            if (params && params.engine) {
                engineInstance = params.engine;
            }

            // инициализация по параметрам app
            if (app.fontFamily) {
                $('*').css('fontFamily',app.fontFamily);
            }
            if (app.background) {
                $('.back_start').css('backgroundImage',app.background);
            }
            if (app.fontColor) {
                $('.cnt_wr').css('color',app.fontColor);
            }
            $('#id-start_header_text').text(app.startHeaderText);
            $('#id-start_desc_text').text(app.startDescription);

            // подготавливаем экраны
            screens = [];
            screens.push({
                id: 'startScr',
                view: $('#id-start_slide'),
                data: {}
            });
            for (var i = 0; i < app.quiz.length; i++) {
                screens.push({
                    id: 'quizScr'+i,
                    view: renderQuestion(i),
                    // во view есть такие строки data-app-property="quiz.{{currentQuestion}}.text"
                    // data нужно для того, чтобы отрендерить это
                    data: {
                        currentQuestion: i
                    },
                    group: 'questions'
                });
            }
            for (var i = 0; i < app.results.length; i++) {
                // каждый резльтат считается отдельным экраном. Так проще управлять результатами
                screens.push({
                    id: 'resultScr'+i,
                    view: renderResult(app.results[i]),
                    data: {
                        currentResult: i
                    },
                    group: 'results',
                    collapse: true // показ экранов всех сразу на одном поле редактирования
                });
            }

            // запуск
            makeUidForQuiz();
            state = undefined;
            next();
        }

        /**
         *
         * @param {string} id - ид экрана
         */
        function getScreen(id) {

        }

        /**
         * Сгенерировать уникальные идишки для вопросов и ответов
         */
        function makeUidForQuiz() {
            for (var j = 0; j < app.quiz.length; j++) {
                for (var i = 0; i < app.quiz[j].options.length; i++) {
                    var o = app.quiz[j].options[i];
                    o.id = MD5.calc(o.text + j + i);
                }
            }
        }

        function renderQuestion(index) {
            currentQuestionIndex = index;
            var q = app.quiz[currentQuestionIndex];
            var $cnt = $('.js-slides_cnt');
            $cnt.empty();
            var templStr = $('#id-slide_template').html();
            templStr = templStr.replace('{{question_text}}', q.text);
            var $slide = $(templStr);
            $cnt.append($slide);
            renderAnswers($slide);
//            if (engineInstance) {
//                engineInstance.bind(['quiz',currentQuestionIndex,'text'], $slide.find('.q_wr'));
//            }
            $slide.find('.js-next').click(function() {
                next();
            });
            return $slide;
        }

        function renderAnswers($slide) {
            for (var i = 0; i < app.quiz[currentQuestionIndex].options.length; i++) {
                var o = app.quiz[currentQuestionIndex].options[i];
                var templStr = $('#id-answer_template').html();

                //TODO важно, костыль: пока нет возможности сделать это в движке, сформировать атрибуты при parseView
                // потому что это надо заменять при рендере ответа
//                templStr = templStr.replace('{{currentOption}}', i);
                var re = new RegExp('{{currentOption}}','g');
                templStr = templStr.replace(re, i);

                templStr = templStr.replace('{{answer_options_text}}', o.text);
                var $e = $(templStr);
                $e.attr('data-id', o.id);
                $e.click(function(e) {
                    if (previewMode === false) {
                        currentOptionId = $(e.currentTarget).attr('data-id');
                        var success = answer(currentOptionId);
                        showExplanation($slide, success);
                    }
                });
                $('.js-answers_cnt').append($e);
            }
        }

        /**
         * Отрисовать результат теста
         *
         * @param {object} result - индекс результата из массива app.results
         */
        function renderResult(result) {
            var $cnt = $('#id-end_slide');
            $cnt.empty();
            var templStr = $('#id-result_template').html();
            var $slide = $(templStr);
            $slide.find('.js-result_title').text(result.title);
            $slide.find('.js-result_description').text(result.description);
            $slide.find('.js-restart').text(app.restartButtonText);
            $cnt.append($slide);
            $slide.find('.js-next').click(function() {
                next();
            });
            return $slide;
        }

        /**
         * Ответить на текущий вопрос
         * @param id - идентификатор выбранного ответа
         * @returns {boolean}
         */
        function answer(id) {
            for (var i = 0; i < app.quiz[currentQuestionIndex].options.length; i++) {
                var o = app.quiz[currentQuestionIndex].options[i];
                if (o.id === id) {
                    if (o.points !== undefined && o.points > 0) {
                        resultPoints += o.points;
                        return true;
                    }
                }
            }
            return false;
        }

        /**
         * Вернуть по идентификатору опцию ответа
         *
         * @param {string} id - идентификатор опции
         * @param {number} currentQuestionIndex - индекс вопроса
         */
        function getOptionById(id, currentQuestionIndex) {
            for (var i = 0; i < app.quiz[currentQuestionIndex].options.length; i++) {
                var o = app.quiz[currentQuestionIndex].options[i];
                if (o.id === id) {
                    return o;
                }
            }
            return null;
        }

        /**
         * Показать верен ли был ответ или нет
         * Также появляется кнопка Далее, чтобы перейти к следующему вопросу
         *
         * @param success - верно ли ответил пользователь
         */
        function showExplanation($slide, success) {
            var $ex = $('.js-slides_cnt').find('.js-explain');
            // add __err modifier if wrong
            if ($ex) {
                if (success !== true) {
                    $ex.addClass('__err');
                }
                $ex.show();
                if (app.showExplanation === true) {
                    var $explText = $('.js-explanation_text');
                    var option = getOptionById(currentOptionId, currentQuestionIndex);
                    if (option.explanation) {
                        // показать объяснение если есть в варианте ответа
                        $explText.text(option.explanation);
                    }
                    else if (app.quiz[currentQuestionIndex].explanation) {
                        // показать объяснение если есть в вопросе
                        $explText.text(app.quiz[currentQuestionIndex].explanation);
                    }
                }
            }
        }

        $(document).ready(function() {
            start();
        });
    </script>
</body>
</html>