<!DOCTYPE html>
<html>
<head>
    <title>Редактор</title>
    <meta charset="UTF-8"/>
    <link href="../settings/css/style.css" rel="stylesheet">
    <style>
        body {
            color: #000;
            margin: 0;
            padding: 0;
        }
        .proto_cnt {
            display: block;
            width: 600px;
            height: 600px;
            padding: 0;
            border: #ff2211 solid 10px;
        }
        .btn {
            background: #13f748;
            background-image: -webkit-linear-gradient(top, #13f748, #168c0f);
            background-image: -moz-linear-gradient(top, #13f748, #168c0f);
            background-image: -ms-linear-gradient(top, #13f748, #168c0f);
            background-image: -o-linear-gradient(top, #13f748, #168c0f);
            background-image: linear-gradient(to bottom, #13f748, #168c0f);
            -webkit-border-radius: 13;
            -moz-border-radius: 13;
            border-radius: 13px;
            font-family: Arial;
            color: #ffffff;
            font-size: 20px;
            padding: 8px 15px 8px 15px;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <p>
        Это вроде редактора.<br>
        В красную рамочку загружается промо-проект для редактирования
    </p>
    <a class="btn" onclick="onPublishClick();">Publish</a>
    <br><br><br>
    <div id="id-product_iframe_cnt">
        <!-- Сюда добавляем программно айфрейм с прототипом для редактирования -->
    </div>
    <input type="file" id="file-chooser" />
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.12.min.js"></script>
    <script type="text/javascript" src="../js/jquery.js"></script>
    <script type="text/javascript" src="../js/utils.js"></script>
    <script type="text/javascript" src="../js/engine.js"></script>
    <script type="text/javascript" src="../js/setting.js"></script>
    <script type="text/javascript" src="../js/appProperty.js"></script>
    <script type="text/javascript" src="../js/queue.js"></script>
    <script>
        //TODO подумать над форматом, где должны храниться продукты всегда. Какое-то одно хранилище?
        var promoProductUrl = '../products/test/index.html';
        //TODO вычислять это по имени продукта
        var baseProductUrl = '../products/test/';
        var promoAppName = 'test1';
        /**
         * Статические ресурсы (скрипты, стили, картинки и прочее), которые надо зааплоадить при сохранении продукта
         */
        var productResources = [];
        var appIframe = null;
        var iframeWindow = null;
        var productBodyStr = null;
        var appId = '515132035326687';
        var roleArn = 'arn:aws:iam::520270155749:role/ProCo_FBUsers';
        var bucketName = 'proconstructor';
        AWS.config.region = 'eu-central-1';
        var fbUserId;
        var facebookAuthEnable = true;
        var bucket = new AWS.S3({
            params: {
                Bucket: bucketName
            }
        });
        var fileChooser = document.getElementById('file-chooser');

        function initProduct() {
            appIframe = document.createElement('iframe');
            appIframe.onload = onProductIframeLoaded;
            $(appIframe).addClass('proto_cnt');
            //TODO set path
            appIframe.src = promoProductUrl;
            $('#id-product_iframe_cnt').append(appIframe);
        }

        function onProductIframeLoaded() {
            var iframeDocument = appIframe.contentDocument || appIframe.contentWindow.document;
            productBodyStr = iframeDocument.documentElement.innerHTML;
            iframeWindow = appIframe.contentWindow;
        }

        function onPublishClick() {
            var iframe = document.getElementById('id-proto_app_cnt');
            var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
            var iframeWindow = iframe.contentWindow;

            var bodyStr = iframeDocument.documentElement.innerHTML;
            var appStr = JSON.stringify(iframeWindow.app);

            log('Publishing: Body length=' + bodyStr.length + ' app length=' + appStr.length);

            publish('testAppName', bodyStr);
        }

        /**
         * Найти все ресурсы, используемые в продукте, и подготовиться к их загрузке
         */
        function buildProductResourceList() {
            productResources = [];
            //TODO поиск предполагает что ресурсы находятся рядом с html в baseUrl
            var scriptExp = /src=(?:\"|\')((?:\w)+\.js)(?:\"|\')/ig;
            var match = null;
            while ( (match = scriptExp.exec(productBodyStr)) !== null) {
                productResources.push({
                   type: 'text/javascript',
                   url: match[1]
                });
            }

            //TODO css

            //TODO img

        }

        function setDataToResource(url, data) {
            for (var i = 0; i < productResources.length; i++) {
                if (productResources[i].url === url) {
                    productResources[i].data = data;
                }
            }
        }

        function test1() {
            var client = new XMLHttpRequest();
            client.open('GET', 'http://localhost:63342/ProCo/products/test/utils.js');
            client.onreadystatechange = function(e) {
                log(e.target.responseText);
            };
            client.send();
        }

        function grabProductResources() {
            productResources = [
                {url:'utils.js'},
                {url:'jquery.js'}
            ];
            for (var i = 0; i < productResources.length; i++) {
                var t = {
                    type: 'grabResTask',
                    // клонируем данные для задачи, так как иначе индекс i сбиндится, будет браться последний из цикла
                    data: JSON.parse(JSON.stringify(productResources[i])),
                    run: function() {
                        var client = new XMLHttpRequest();
                        log('Loading resource: ' + baseProductUrl + this.data.url);
                        client.open('GET', baseProductUrl + this.data.url);
                        client.onreadystatechange = (function(e) {
                            if (e.target.readyState == 4) {
                                if(e.target.status == 200) {
                                    // task context
                                    log('task done');
                                    setDataToResource(this.data.url, e.target.responseText);
                                }
                                else {
                                    log('Resource request failed: '+ myRequest.statusText, true);
                                }
                                // даем понять, что таск завершен
                                Queue.release(this);
                            }
                        }).bind(this);
                        client.send();
                        log('client.send');
                    },
                    done: function(e) {
                    }
                };
                Queue.push(t);
            }

            //TODO сделать поддержку таких событий
            Queue.onComplete('grabResTask', function(){
                log('All resources grabbed.');
            })
            // добавляем главный html файл
            productResources.push({
                url: 'index.html',
                type: 'text/html',
                data: productBodyStr
            });
        }

        /**
         * Сохранить все статические ресурсы проекта в хранилище
         */
        function uploadProductResources() {
            for (var i = 0; i < productResources.length; i++) {
                var t = {
                    type: 'uploadResTask',
                    // клонируем данные для задачи, так как иначе индекс i сбиндится, будет браться последний из цикла
                    data: JSON.parse(JSON.stringify(productResources[i])),
                    run: function() {
                        var objKey = 'facebook-'+fbUserId+'/'+promoAppName+'/'+this.data.url;
                        var params = {
                            Key: objKey,
                            ContentType: this.data.type,
                            Body: this.data.data,
                            ACL: 'public-read'
                        };
                        bucket.putObject(params, (function (err, data) {
                            // task object context
                            if (err) {
                                //Not authorized to perform sts:AssumeRoleWithWebIdentity
                                log('ERROR: ' + err, true);
                            } else {
//                                listObjs();
                            }
                            Queue.release(this);
                        }).bind(this));
                    }
                };
                Queue.push(t);
            }
        }

        function publish() {
//            var file = fileChooser.files[0];
//            if (file) {
//                var objKey = 'facebook-' + fbUserId + '/' + file.name;
//                var params = {
//                    Key: objKey,
//                    ContentType: file.type,
//                    Body: file,
//                    ACL: 'public-read'
//                };
//                bucket.putObject(params, function (err, data) {
//                    if (err) {
//                        //Not authorized to perform sts:AssumeRoleWithWebIdentity
//                        log('ERROR: ' + err, true);
//                    } else {
//                        listObjs();
//                    }
//                });
//            }
        }

        function listObjs() {
            var prefix = 'facebook-' + fbUserId;
            bucket.listObjects({
                Prefix: prefix
            }, function (err, data) {
                if (err) {
                    log('ERROR: ' + err, true);
                } else {
                    var objKeys = "";
                    data.Contents.forEach(function (obj) {
                        objKeys += obj.Key + "<br>";
                    });
                    log('listObjects...');
                    log(objKeys);
                }
            });
        }

        if (facebookAuthEnable === true) {
            /*!
             * Login to your application using Facebook.
             * Uses the Facebook SDK for JavaScript available here:
             * https://developers.facebook.com/docs/javascript/gettingstarted/
             */
            window.fbAsyncInit = function () {
                FB.init({
                    appId: appId
                });
                FB.login(function (response) {
                    bucket.config.credentials = new AWS.WebIdentityCredentials({
                        ProviderId: 'graph.facebook.com',
                        RoleArn: roleArn,
                        WebIdentityToken: response.authResponse.accessToken
                    });
                    fbUserId = response.authResponse.userID;
                });
            };
            // Load the Facebook SDK asynchronously
            (function (d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) {
                    return;
                }
                js = d.createElement(s);
                js.id = id;
                js.src = "//connect.facebook.net/en_US/all.js";
                fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
        }

        $(document).ready(function(){
            initProduct();
        })
    </script>
</body>
</html>