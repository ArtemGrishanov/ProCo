<!DOCTYPE html>
<html>
<head>
    <title>Редактор</title>
    <meta charset="UTF-8"/>
    <link href="../settings/css/style.css" rel="stylesheet">
    <style>
        body {
            color: #000;
            margin: 0;
            padding: 0;
        }
        .proto_cnt {
            display: block;
            width: 600px;
            height: 600px;
            padding: 0;
            border: #ff2211 solid 10px;
        }
        .btn {
            background: #13f748;
            background-image: -webkit-linear-gradient(top, #13f748, #168c0f);
            background-image: -moz-linear-gradient(top, #13f748, #168c0f);
            background-image: -ms-linear-gradient(top, #13f748, #168c0f);
            background-image: -o-linear-gradient(top, #13f748, #168c0f);
            background-image: linear-gradient(to bottom, #13f748, #168c0f);
            -webkit-border-radius: 13;
            -moz-border-radius: 13;
            border-radius: 13px;
            font-family: Arial;
            color: #ffffff;
            font-size: 20px;
            padding: 8px 15px 8px 15px;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <p>
        Это вроде редактора.<br>
        В красную рамочку загружается промо-проект для редактирования
    </p>
    <a class="btn" onclick="onPublishClick();">Publish</a>
    <a class="btn" onclick="onEditClick();">Мне повезет!</a>
    <br><br><br>
    <div id="id-product_iframe_cnt">
        <!-- Сюда добавляем программно айфрейм с прототипом для редактирования -->
    </div>
    <!--<input type="file" id="file-chooser" />-->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.12.min.js"></script>
    <script type="text/javascript" src="../js/jquery.js"></script>
    <script type="text/javascript" src="../js/config.js"></script>
    <script type="text/javascript" src="../js/utils.js"></script>
    <script type="text/javascript" src="../js/engine.js"></script>
    <script type="text/javascript" src="../js/setting.js"></script>
    <script type="text/javascript" src="../js/appProperty.js"></script>
    <script type="text/javascript" src="../js/queue.js"></script>
    <script>
        //TODO подумать над форматом, где должны храниться продукты всегда. Какое-то одно хранилище?
        var baseProductUrl = '../products/test/';
        var indexHtml = 'index.html';

        //TODO ид каждого проекта должен быть уникален {id, name, author ....}
        var promoAppName = 'test1';
        /**
         * Статические ресурсы (скрипты, стили, картинки и прочее), которые надо зааплоадить при сохранении продукта
         */
        var productResources = [];
        var appIframe = null;
        var iframeWindow = null;
        var fbUserId;
        var facebookAuthEnable = true;
        AWS.config.region = config.common.awsRegion;
        var bucket = new AWS.S3({
            params: {
                Bucket: config.common.bucketName
            }
        });
        var fileChooser = document.getElementById('file-chooser');
        var errorInPublish = false;

        function getDistribUrl() {
            return config.common.hostName+config.common.bucketName+'/facebook-'+fbUserId+'/'+promoAppName+'/';
        }

        function initProduct() {
            appIframe = document.createElement('iframe');
            appIframe.onload = onProductIframeLoaded;
            $(appIframe).addClass('proto_cnt');
            //TODO set path
            appIframe.src = baseProductUrl + indexHtml;
            $('#id-product_iframe_cnt').append(appIframe);
        }

        /**
         * iFrame промо проекта был загружен. Получаем из него document и window
         */
        function onProductIframeLoaded() {
            iframeWindow = appIframe.contentWindow;
            Engine.startEngine(iframeWindow);
            //TODO редактирование становится доступным показать в интерфейсе
        }

        function onEditClick() {
            //TODO смотреть по engine AppProperties что можно редактировать
            //TODO устанавливать свойства через engine которая запускает тест
            var fontColors = config.products.tests.fontColors;
            var fontFamilies = config.products.tests.fontFamilies;
            var backgrounds = config.products.tests.backgrounds;
            Engine.setValue('fontColor',fontColors[getRandomArbitrary(0,fontColors.length-1)]);
            Engine.setValue('fontFamily',fontFamilies[getRandomArbitrary(0,fontFamilies.length-1)]);
            Engine.setValue('background',backgrounds[getRandomArbitrary(0,backgrounds.length-1)]);
            // перезапускаем промо приложение
//            iframeWindow.start();
        }

        function onPublishClick() {
            publish();
        }

        /**
         * Для указанного имени ресурса задать загруженные данные
         */
        function setDataToResource(url, data) {
            for (var i = 0; i < productResources.length; i++) {
                if (productResources[i].url === url) {
                    productResources[i].data = data;
                }
            }
        }

        /**
         * Вернуть объект-ресурс по его url
         */
        function getResourceByUrl(url) {
            for (var i = 0; i < productResources.length; i++) {
                if (productResources[i].url === url) {
                    return productResources[i];
                }
            }
            return null;
        }

        /**
         * Найти все ресурсы, используемые в продукте, и подготовиться к их загрузке
         */
        function buildProductResourceList(codeStr) {
            productResources = [];
            //TODO поиск предполагает что ресурсы находятся рядом с html в baseUrl
            var scriptExp = /src=(?:\"|\')((?:\w)+\.js)(?:\"|\')/ig;
            var jsMatch = null;
            while ( (jsMatch = scriptExp.exec(codeStr)) !== null) {
                productResources.push({
                   type: 'text/javascript',
                   url: jsMatch[1]
                });
            }
            var cssExp = /href=(?:\"|')((?:\w)+.css)(?:\"|')/ig;
            var cssMatch = null;
            while ( (cssMatch = cssExp.exec(codeStr)) !== null) {
                productResources.push({
                    type: 'text/css',
                    url: cssMatch[1]
                });
            }
            //TODO img (только "свои" картинки) Из инетов пока не рассматриваем варианты

            // добавляем главный html файл
            productResources.push({
                url: indexHtml,
                type: 'text/html'
            });
        }

        /**
         * Собрать все ресурсы промо-проекта и положить их в productResources
         * Ресурсы загружаются в помощью XMLHttpRequest
         *
         * @param param
         */
        function grabProductResources(param) {
            for (var i = 0; i < productResources.length; i++) {
                if (!productResources[i].data) {
                    var t = {
                        // клонируем данные для задачи, так как иначе индекс i сбиндится, будет браться последний из цикла
                        data: JSON.parse(JSON.stringify(productResources[i])),
                        run: function() {
                            log('Grab task run:' + baseProductUrl + this.data.url);
                            var client = new XMLHttpRequest();
                            client.open('GET', baseProductUrl + this.data.url);
                            client.onreadystatechange = (function(e) {
                                if (e.target.readyState == 4) {
                                    if(e.target.status == 200) {
                                        // task context
                                        log('Grab task done:' + this.data.url);
                                        setDataToResource(this.data.url, e.target.responseText);
                                    }
                                    else {
                                        log('Resource request failed: '+ myRequest.statusText, true);
                                    }
                                    // даем понять, что таск завершен
                                    Queue.release(this);
                                }
                            }).bind(this);
                            client.send();
                        },
                        done: function(e) {
                        }
                    };
                    if (param.taskType) {
                        t.type = param.taskType;
                    }
                    if (param.priority) {
                        t.priority = param.priority;
                    }
                    Queue.push(t);
                }
            }
        }

        /**
         * Переписать параметры промо-приложения прототипа на новые, которые получились в результате редактирования
         *
         * @param param
         */
        function overrideAppParams(param) {
            var t = {
                data: '',
                run: function() {
                    // здесь происходит подмена параметров промо приложения на новые. Те, которые были настроены пользователем.
                    var indexResource = getResourceByUrl(indexHtml);
                    var startFuncReg = /(function(?:\s)+start(?:\s)*\((?:\w)*\)(?:\s)*\{)/ig;
                    var match = startFuncReg.exec(indexResource.data);
                    var positionToInsert = match.index+match[1].length;
                    var strAppProperties = JSON.stringify(iframeWindow.app);
                    var overrideParamsStr = '\nvar o='+strAppProperties+';'+'for(var key in o)if(o.hasOwnProperty(key))app[key]=o[key];\n'
                    indexResource.data = indexResource.data.slice(0,positionToInsert) + overrideParamsStr + indexResource.data.slice(positionToInsert);
                    Queue.release(this);
                }
            };
            if (param.taskType) {
                t.type = param.taskType;
            }
            if (param.priority) {
                t.priority = param.priority;
            }
            Queue.push(t);
        }

        /**
         * Сохранить все статические ресурсы проекта в хранилище
         *
         * @param param
         */
        function uploadProductResources(param) {
            for (var i = 0; i < productResources.length; i++) {
                var t = {
                    // клонируем данные для задачи, так как иначе индекс i сбиндится, будет браться последний из цикла
                    data: JSON.parse(JSON.stringify(productResources[i])),
                    run: function() {
                        log('Upload task run:' + this.data.url);
                        var objKey = 'facebook-'+fbUserId+'/'+promoAppName+'/'+this.data.url;
                        var params = {
                            Key: objKey,
                            ContentType: this.data.type,
                            Body: this.data.data,
                            ACL: 'public-read'
                        };
                        bucket.putObject(params, (function (err, data) {
                            // task object context
                            if (err) {
                                errorInPublish = true;
                                log('ERROR: ' + err, true);
                            }
                            log('Upload task done:' + this.data.url);
                            Queue.release(this);
                        }).bind(this));
                    }
                };
                if (param.taskType) {
                    t.type = param.taskType;
                }
                if (param.priority) {
                    t.priority = param.priority;
                }
                Queue.push(t);
            }
        }

        /**
         * Сохранить промо проект на сервере
         * 1) Для этого сначала составляется список всех ресурсов проекта: css, js, картинки
         * 2) Затем они скачиваются
         * 3) Загружаются в хранилище в персональный каталог пользователя
         */
        function publish() {
            errorInPublish = false;
            //TODO собираем ресурсы в несколько проходов
            // например, для того чтобы забрать картинку, сначала надо скачать и распарсить файл css
            var iframeDocument = appIframe.contentDocument || appIframe.contentWindow.document;
            buildProductResourceList(iframeDocument.documentElement.innerHTML);
            //подписка на окончания задач по сбору ресурсов для проекта
            Queue.onComplete('grabResTask', function(){
                log('All resources grabbed.');

                //TODO меняем ссылки на картинки
//            var imgReg = /((?:\w)+\/(?:\w)+\.(?:jpg|jpeg|png))/ig;
//            for (var i = 0; i < productResources.length; i++) {
//                var imgMatch = null;
//                while ( (imgMatch = imgReg.exec(productResources.data)) !== null) {
//                    //imgMatch[1]
//                }
//            }
                Queue.onComplete('overrideApp', function(){
                    log('Apps were overrided.');
                });
                overrideAppParams({
                    taskType:'overrideApp',
                    priority:9
                });
                Queue.onComplete('uploadRes', function(){
                    if (errorInPublish === true) {
                        alert('Ошибка')
                    }
                    else {
                        log('All resources were uploaded.');
                        showEmbedDialog();
                    }
                });
                uploadProductResources({
                    taskType:'uploadRes',
                    priority:8
                });
            });
            grabProductResources({
                taskType:'grabResTask',
                priority:10
            });
        }

        /**
         * Показать окно для вставки со ссылкой
         */
        function showEmbedDialog() {
            var iframeUrl =  getDistribUrl()+indexHtml;
            var embedLink = '<iframe src="'+iframeUrl+'" style="display:block;width:600px;height:600px;padding:0;border:none;"></iframe>';
            alert(embedLink);
        }

        function listObjs() {
            var prefix = 'facebook-' + fbUserId;
            bucket.listObjects({
                Prefix: prefix
            }, function (err, data) {
                if (err) {
                    log('ERROR: ' + err, true);
                } else {
                    var objKeys = "";
                    data.Contents.forEach(function (obj) {
                        objKeys += obj.Key + "<br>";
                    });
                    log('listObjects...');
                    log(objKeys);
                }
            });
        }

        //            var file = fileChooser.files[0];
        //            if (file) {
        //                var objKey = 'facebook-' + fbUserId + '/' + file.name;
        //                var params = {
        //                    Key: objKey,
        //                    ContentType: file.type,
        //                    Body: file,
        //                    ACL: 'public-read'
        //                };
        //                bucket.putObject(params, function (err, data) {
        //                    if (err) {
        //                        //Not authorized to perform sts:AssumeRoleWithWebIdentity
        //                        log('ERROR: ' + err, true);
        //                    } else {
        //                        listObjs();
        //                    }
        //                });
        //            }

        if (facebookAuthEnable === true) {
            /*!
             * Login to your application using Facebook.
             * Uses the Facebook SDK for JavaScript available here:
             * https://developers.facebook.com/docs/javascript/gettingstarted/
             */
            window.fbAsyncInit = function () {
                FB.init({
                    appId: config.common.facebookAppId
                });
                FB.login(function (response) {
                    bucket.config.credentials = new AWS.WebIdentityCredentials({
                        ProviderId: 'graph.facebook.com',
                        RoleArn: config.common.roleArn,
                        WebIdentityToken: response.authResponse.accessToken
                    });
                    fbUserId = response.authResponse.userID;
                });
            };
            // Load the Facebook SDK asynchronously
            (function (d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) {
                    return;
                }
                js = d.createElement(s);
                js.id = id;
                js.src = "//connect.facebook.net/en_US/all.js";
                fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
        }

        $(document).ready(function(){
            initProduct();
        })
    </script>
</body>
</html>